---
title: "P8105 HW2 - swr2118"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)
library(dplyr)
library(tidyr)
library(readr)
```


# Problem 1
```{r problem1-load-and-clean}
library(tidyverse)

# Read data files
pols_month <- read_csv("pols-month.csv")
unemployment <- read_csv("unemployment.csv")
snp <- read_csv("snp.csv")

# Clean pols_month
pols_month_clean <- pols_month %>%
  separate(mon, into = c("year", "month", "day"), sep = "-") %>%
  mutate(
    year = as.integer(.data$year),
    month = as.integer(.data$month),
    president = if_else(prez_gop == 1, "gop", "dem")
  ) %>%
  select(-prez_dem, -prez_gop, -day)

# Clean snp
snp_clean <- snp %>%
  separate(date, into = c("year", "month", "day"), sep = "-") %>%
  mutate(
    year = as.integer(.data$year),
    month = as.integer(.data$month)
  ) %>%
  arrange(year, month) %>%
  select(year, month, close, everything(), -day)

# Clean unemployment
unemployment_tidy <- unemployment %>%
  pivot_longer(
    Jan:Dec,
    names_to = "month",
    values_to = "unemployment"
  ) %>%
  mutate(
    month = match(month, month.abb),
    year = as.integer(.data$Year)
  )

# Join datasets
combined <- pols_month_clean %>%
  left_join(snp_clean, by = c("year", "month")) %>%
  left_join(unemployment_tidy, by = c("year", "month"))

# Optionally add a character month name for display
combined <- combined %>%
  mutate(month_name = month.name[month])

glimpse(combined)
```


**Summary:**  
The pols-month file contains monthly political data on the presidency. The snp file contains S&P index monthly closing data. The unemployment file contains annual unemployment rates in wide format. After cleaning and merging, the combined dataset has `r nrow(combined)` rows and `r ncol(combined)` columns, spanning years `r min(combined$year, na.rm=TRUE)` to `r max(combined$year, na.rm=TRUE)`. Key variables include year, month, president, S&P closing value, and unemployment rate.

# Problem 2

```{r problem2}
# Read in all Trash Wheel sheets
mr_trash <- read_excel("202409 Trash Wheel Collection Data.xlsx", sheet = "Mr. Trash Wheel", skip = 1)
prof_trash <- read_excel("202409 Trash Wheel Collection Data.xlsx", sheet = "Professor Trash Wheel", skip = 1)
gwynnda_trash <- read_excel("202409 Trash Wheel Collection Data.xlsx", sheet = "Gwynnda Trash Wheel", skip = 1)

# Clean and add wheel name
clean_trash <- function(df, wheel_name, has_sports = FALSE) {
  df <- janitor::clean_names(df) %>% 
    filter(!is.na(dumpster))
  print(colnames(df)) # DEBUG: check column names
  if ("year" %in% names(df)) {
    df <- df %>% mutate(year = as.integer(year))
  }
if (has_sports && "sports_balls" %in% names(df)) {
    df <- df %>% mutate(sports_balls = as.integer(round(sports_balls)))
  }
  df %>%
    mutate(wheel = wheel_name)
}

mr_clean <- clean_trash(mr_trash, "Mr. Trash Wheel", has_sports = TRUE)
prof_clean <- clean_trash(prof_trash, "Professor Trash Wheel")
gwynnda_clean <- clean_trash(gwynnda_trash, "Gwynnda Trash Wheel")

# Combine all
trash_all <- bind_rows(mr_clean, prof_clean, gwynnda_clean)

# Inline results
num_obs <- nrow(trash_all)
prof_total_weight <- sum(prof_clean$weight_tons, na.rm = TRUE)
gwynnda_june2022_cigs <- gwynnda_clean %>%
  filter(year == 2022, month == "June") %>%
  pull(cigarette_butts) %>%
  sum(na.rm = TRUE) %>%
  as.integer()
```

The combined trash wheel dataset has `r num_obs` observations. Example variables include `dumpster`, `month`, `year`, `weight_tons`, `sports_balls`, and `cigarette_butts`.  
The total weight of trash collected by Professor Trash Wheel is `r round(prof_total_weight,2)` tons. Gwynnda collected `r gwynnda_june2022_cigs` cigarette butts in June 2022.

# Problem 3

```{r problem3}
# Load Zillow and ZIP code data
zillow <- read_csv("Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv")
zipcodes <- read_csv("Zip Codes.csv")

# Rename RegionName to ZipCode in zillow for joining
zillow <- zillow %>% rename(ZipCode = RegionName)

# Tidy zillow data
zillow_long <- zillow %>%
  pivot_longer(
    cols = matches("^\\d{4}-\\d{2}-\\d{2}$"),
    names_to = "date",
    values_to = "rent"
  ) %>%
  mutate(date = as.Date(date)) %>%
  left_join(zipcodes, by = "ZipCode") %>%
  mutate(borough = County)

# Summary stats
total_obs <- nrow(zillow_long)
unique_zips <- length(unique(zillow_long$ZipCode))
unique_neigh <- length(unique(zillow_long$Neighborhood))

# ZIPs in zipcodes not in zillow
missing_zips <- setdiff(zipcodes$ZipCode, zillow$ZipCode)

# Table: 10 ZIPs with largest rent drop Jan 2020 â†’ Jan 2021
rent_2020_2021 <- zillow_long %>%
  filter(month(date) == 1, year(date) %in% c(2020, 2021)) %>%
  select(ZipCode, borough, Neighborhood, date, rent) %>%
  pivot_wider(names_from = date, values_from = rent, names_prefix = "rent_") %>%
  mutate(
    drop = .data[[paste0("rent_", as.Date("2021-01-31"))]] - .data[[paste0("rent_", as.Date("2020-01-31"))]]
  ) %>%
  arrange(drop) %>%
  slice(1:10)

rent_2020_2021 %>%
  select(ZipCode, borough, Neighborhood, drop)
```

The tidy Zillow dataset contains `r total_obs` observations, with `r unique_zips` unique ZIP codes and `r unique_neigh` unique neighborhoods.  
ZIP codes present in the ZIP code dataset but not in the Zillow rental dataset include: `r paste(head(missing_zips, 5), collapse = ", ")` (first 5 shown). These ZIPs may be missing from Zillow if they are commercial, uninhabited, or otherwise have no rental listings.  
The table above shows the 10 ZIP codes with the largest decrease in rent from January 2020 to January 2021, likely reflecting COVID-19 market effects.
